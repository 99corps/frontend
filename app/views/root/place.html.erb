<% content_for :extra_javascript do %>
	<%= javascript_include_tag 'trackers/findmynearest.js', :defer=>"defer" %>
<% end %>
<section id="content" role="main" class="group">

  <header class="page-header group">
   <hgroup>
     <h1><span>Service</span> <%= @place.title %></h1>
   </hgroup>
  </header>
	<div class="article-container group">
	 	<article role="article" class="group">
	    <div class="inner">

	      <section class="intro">
  	      <div class="get-started-intro">

  	        <div class="find-nearest">

    	        <%= to_govspeak(@place.introduction) %>

              <form method="post" id="local-locator-form" class="find-location-for-service">
      	        <fieldset>

      	          <legend class="visuallyhidden">Postcode lookup</legend>
      	          <% if @edition %>
      	            <input type="hidden" name="edition" value="<%= @edition %>">
      	          <% end %>
                  <div class="location_error error-notification hidden"></div>

      	          <div class="ask_location <%= geo_known_to_at_least?('ward') ? 'hidden' : '' %>">
      	            <label for="postcode">Enter a UK postcode <input class="postcode" id="postcode" name="postcode" type="text" placeholder="e.g. SW1A 2AA"></label>
      	            <input type="submit" value="Find" class="button">
      	          </div>

      	          <div class="finding_location hidden">
      	            <p>Locating you&hellip;</p>
      	          </div>
      	          <div class="found_location <%= geo_known_to_at_least?('ward') ? '' : 'hidden' %>">
      	            <p class="friendly-name">Your location is set to <strong><%= geo_header['friendly_name'] if geo_known_to_at_least?('ward') %></strong>.<br/><a class="change-location" href="<%= publication_path(@place.slug) %>"><%= "Change your location".html_safe %></a></p>
      	          </div>
      	        </fieldset>
    	        </form>

            </div>
          </div>
        </section>

        <section class="more">
          <% if ! @place.more_information.blank? and !geo_known_to_at_least?('ward') %>
            <div class="further_information">
              <h2>Further information</h2>

              <% if @place.expectations.any? %>
                <ul class="helpers group">
                  <% @place.expectations.each do |e| %>
                    <li class="<%= e.css_class %>">
                    <%= e.text %>
                    </li>
                  <% end %>
                </ul>
              <% end %>

              <%= to_govspeak(@place.more_information) %>
            </div>
          <% end %>
	      </section>

        <section class"">
        <% if @options.any? %>
          <h3 id="options-header">Results near <strong><%= geo_header['friendly_name'] if geo_known_to_at_least?('ward') %></strong>:</h3>
          <ol id="options" class="places">
           <%= mustache_partial '_option.html', {'options' => @options} %>
          </ol>
        <% elsif params[:postcode].present? %>
          <div id="results-error" class="error-notification"><p>Sorry, no results were found near you.</p></div>
        <% else %>
          <h3 id="options-loading" class="hidden">Loading results near <strong class="locality_placeholder"></strong>.</h3>
          <div class="hidden error-notification" id="results-error"><p></p></div>
          <h3 id="options-header" class="hidden">Results near <strong class="locality_placeholder"></strong>:</h3>
          <ol id="options" class="places">
          </ol>
        <% end %>
        </section>

      </div>

		</article>
    <%= render 'publication_metadata', :publication => @place, :artefact => @artefact, :api_links => Hash[[:json].map { |format| [format, "#{@place.place_type}.#{format}"] }] %>
	</div>
</section>

<div id="related-items"></div>

  <script id="option-template" type="text/x-mustache-template">
  <%= mustache_direct '_option.html' %>
  </script>

  <script>

  $(document).ready(function() {

      <% unless geo_known_to_at_least?('ward') -%>
        var form = new AlphaGeoForm('#local-locator-form');

        var load_new_locations = function() {
          $('.further_information').hide();
          $('#options-loading').removeClass('hidden');
          $.ajax({
            url: "<%= publication_path(@place.slug, :format => 'json') %>",
            dataType: 'json',
            data: {
              lat: AlphaGeo.full_location.current_location.lat,
              lon: AlphaGeo.full_location.current_location.lon
            },
            type: 'POST',
            success: function (data) {
              $('#options-loading').addClass('hidden');

              if (data.places.length > 0) {
                $('h3#options-header').show().removeClass('hidden');
                $('#options').html($.mustache($('#option-template').html(), {options: data.places}));
              } else {
                $('#results-error').removeClass('hidden').find('p').text('Sorry, no results were found near you.');
              }
              _gaq.push(['_trackEvent', 'Citizen-Format-Findmynearest', 'Success-results']);
              $('#options-header').show();
            }
          });
        }

        var remove_existing_location_data = function() {
          $("#options").html('');
          $('#options-header').hide();
          $('#results-error').addClass('hidden');
        }

        $(AlphaGeo).bind('location-removed', function(e, message) {
          remove_existing_location_data();
          $('.further_information').show();
        });

        $(AlphaGeo).bind('location-completed', function(e, location) {
          remove_existing_location_data();
          $('strong.locality_placeholder').text(AlphaGeo.full_location.current_location.locality);
          load_new_locations();
        });
      <% end %>

    });
    </script>
